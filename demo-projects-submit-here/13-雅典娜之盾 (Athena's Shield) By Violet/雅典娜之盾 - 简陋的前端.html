<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›…å…¸å¨œä¹‹ç›¾ - Athena's Shield</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥Ethers.js -->
    <script src="https://cdn.ethers.io/lib/ethers-5.6.umd.min.js"></script>
    <style>
        /* è‡ªå®šä¹‰å­—ä½“å’Œä¸€äº›ç»†å¾®æ ·å¼ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap');
        
        /* æ ¹å…ƒç´ å®šä¹‰é…è‰²æ–¹æ¡ˆ */
        :root {
            --bg-color: #EAE9E6; /* èƒŒæ™¯è‰² - ç§‘ç½—æ‹‰å¤š */
            --text-color: #594A69; /* æ–‡å­—/Logoä¸»è‰² - æ·±ç´« */
            --text-light-color: #7d6c91; /* æµ…è‰²æ–‡å­— */
            --accent-color: #594A69; /* å¼ºè°ƒè‰² */
            --accent-hover-color: #473a54; /* å¼ºè°ƒè‰²æ‚¬æµ® */
            --card-bg-color: rgba(255, 255, 255, 0.7); /* å¡ç‰‡èƒŒæ™¯ */
            --card-border-color: rgba(89, 74, 105, 0.1); /* å¡ç‰‡è¾¹æ¡† */
            --input-bg-color: #F5F5F3; /* è¾“å…¥æ¡†èƒŒæ™¯ */
            --input-border-color: #D1D5DB; /* è¾“å…¥æ¡†è¾¹æ¡† */
            --progress-bar-bg: #DCD9D4; /* è¿›åº¦æ¡èƒŒæ™¯ */
        }

        body {
            font-family: 'Noto Sans SC', 'Nunito', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .card-style {
            background-color: var(--card-bg-color);
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border-color);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
        }
        .main-accent-text {
            color: var(--accent-color);
        }
        .progress-bar-inner {
            background-color: var(--accent-color);
        }
        .title-font {
             font-family: 'Noto Sans SC', sans-serif; /* å¯ä»¥æŒ‡å®šä¸€ä¸ªæ›´å…·è‰ºæœ¯æ„Ÿçš„æ ‡é¢˜å­—ä½“ */
             font-weight: 900;
        }
    </style>
</head>
<body class="antialiased">

    <!-- å¯¼èˆªæ  -->
    <nav class="p-4 flex justify-between items-center card-style sticky top-0 z-10">
        <div class="flex items-center">
            <!-- æ›´æ–°åçš„SVG Logo -->
            <div class="w-10 h-10 mr-3 flex items-center justify-center">
                <svg width="100%" height="100%" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 2.5L95.45 26.25V73.75L50 97.5L4.55 73.75V26.25L50 2.5Z" stroke="#594A69" stroke-width="5"/>
                    <path d="M50 15L86.6 35V65L50 85L13.4 65V35L50 15Z" stroke="#594A69" stroke-width="3" stroke-opacity="0.5"/>
                    <path d="M35 40L50 25L65 40V55L50 70L35 55V40Z" fill="#594A69"/>
                </svg>
            </div>
            <h1 class="text-xl font-bold tracking-wider main-accent-text">é›…å…¸å¨œä¹‹ç›¾</h1>
        </div>
        <button id="connectWalletBtn" class="bg-[var(--accent-color)] hover:bg-[var(--accent-hover-color)] text-white font-bold py-2 px-4 rounded-lg transition duration-300">
            è¿æ¥é’±åŒ…
        </button>
    </nav>

    <!-- ä¸»ä½“å†…å®¹ -->
    <main class="container mx-auto p-4 md:p-8">
        
        <!-- å¤´éƒ¨ä»‹ç» -->
        <header class="text-center mb-12">
            <h2 class="text-4xl md:text-5xl font-bold mb-4 title-font">ç”¨ä»£ç ä½œç›¾ï¼Œä»¥å…±è¯†ä¸ºå…‰</h2>
            <p class="text-[var(--text-light-color)] max-w-2xl mx-auto">ä¸€ä¸ªç”±ç¤¾åŒºé©±åŠ¨ï¼Œé€šè¿‡æè‡´é€æ˜çš„é“¾ä¸Šæµç¨‹ï¼Œä¸ºç¤¾åŒºæˆå‘˜æä¾›å…³é”®èµ„æºçš„å»ä¸­å¿ƒåŒ–äº’åŠ©ç½‘ç»œã€‚</p>
        </header>

        <!-- ç®¡ç†å‘˜é¢æ¿ - åªæœ‰åˆçº¦æ‰€æœ‰è€…å¯è§ -->
        <div id="adminPanel" class="hidden card-style p-6 rounded-2xl mb-12">
            <h3 class="text-2xl font-bold mb-4 border-b border-[var(--card-border-color)] pb-2">é­”æ³•å¸ˆçš„å·¥åŠ ğŸ§™</h3>
            <div class="grid md:grid-cols-2 gap-6">
                <!-- åˆ›å»ºæ–°é¡¹ç›® -->
                <div>
                    <h4 class="text-lg font-semibold mb-2 main-accent-text">é“¸é€ æ–°çš„å®ˆæŠ¤å¥‘çº¦</h4>
                    <input id="beneficiary" type="text" placeholder="å—ç›Šäººåœ°å€" class="w-full bg-[var(--input-bg-color)] p-2 rounded mb-2 border border-[var(--input-border-color)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] text-[var(--text-color)]">
                    <input id="fundingGoal" type="number" placeholder="å‹Ÿæ¬¾ç›®æ ‡ (USDC)" class="w-full bg-[var(--input-bg-color)] p-2 rounded mb-2 border border-[var(--input-border-color)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] text-[var(--text-color)]">
                    <button id="createCampaignBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        å‘èµ·å¥‘çº¦
                    </button>
                </div>
            </div>
        </div>

        <!-- é¡¹ç›®åˆ—è¡¨ -->
        <div>
            <h3 class="text-3xl font-bold mb-8 text-center title-font">å®ˆæŠ¤ä¸­çš„å¥‘çº¦</h3>
            <div id="campaignsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- åŠ¨æ€åŠ è½½çš„é¡¹ç›®å¡ç‰‡å°†æ’å…¥è¿™é‡Œ -->
                <div id="loadingIndicator" class="text-center col-span-full">
                    <p>æ­£åœ¨ä»æ˜Ÿç•Œç½‘ç»œè¯»å–å¥‘çº¦...</p>
                </div>
            </div>
        </div>

    </main>
    
    <!-- æ¶ˆæ¯æç¤ºæ¡† -->
    <div id="toast" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg">
      <p id="toastMessage"></p>
    </div>


<script>
// --- é…ç½®å’Œå¸¸é‡ ---

// !!é‡è¦!! éƒ¨ç½²åˆçº¦åï¼Œè¯·ç”¨ä½ çš„åˆçº¦åœ°å€æ›¿æ¢è¿™é‡Œçš„åœ°å€
const CAMPAIGN_FACTORY_ADDRESS = "YOUR_CAMPAIGN_FACTORY_ADDRESS_HERE"; 
const USDC_TOKEN_ADDRESS = "YOUR_USDC_TESTNET_ADDRESS_HERE"; // ä¾‹å¦‚ Sepoliaæµ‹è¯•ç½‘ä¸Šçš„USDCåœ°å€

// åˆçº¦çš„ABI (åº”ç”¨äºŒè¿›åˆ¶æ¥å£) - è¿™æ˜¯ç¼–è¯‘å™¨ç”Ÿæˆçš„JSONï¼Œå‘Šè¯‰å‰ç«¯å¦‚ä½•ä¸åˆçº¦äº¤äº’
// ä½ éœ€è¦ä»Remixä¸­ç¼–è¯‘åçš„æ–‡ä»¶ä¸­å¤åˆ¶è¿™äº›ABI
const CAMPAIGN_FACTORY_ABI = [
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "campaignAddress",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "beneficiary",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "goal",
				"type": "uint256"
			}
		],
		"name": "CampaignCreated",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_beneficiary",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "_fundingGoal",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "_tokenAddress",
				"type": "address"
			}
		],
		"name": "createCampaign",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getDeployedCampaigns",
		"outputs": [
			{
				"internalType": "address[]",
				"name": "",
				"type": "address[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];
const CAMPAIGN_ABI = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_beneficiary",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "_fundingGoal",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "_tokenAddress",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "_manager",
				"type": "address"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "donor",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "Donated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "milestoneId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "description",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "MilestoneCreated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "milestoneId",
				"type": "uint256"
			}
		],
		"name": "MilestoneReleased",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "beneficiary",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "contributions",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_description",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "_amount",
				"type": "uint256"
			}
		],
		"name": "createMilestone",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_amount",
				"type": "uint256"
			}
		],
		"name": "donate",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "fundingGoal",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getBalance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "manager",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "milestones",
		"outputs": [
			{
				"internalType": "string",
				"name": "description",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "released",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_milestoneId",
				"type": "uint256"
			}
		],
		"name": "releaseMilestoneFunds",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "token",
		"outputs": [
			{
				"internalType": "contract IERC20",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalRaised",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];
const ERC20_ABI = [
  "function approve(address spender, uint256 amount) external returns (bool)",
  "function allowance(address owner, address spender) external view returns (uint256)"
];


// --- å…¨å±€å˜é‡ ---
let provider;
let signer;
let userAddress;
let factoryContract;

// --- DOMå…ƒç´  ---
const connectWalletBtn = document.getElementById('connectWalletBtn');
const adminPanel = document.getElementById('adminPanel');
const createCampaignBtn = document.getElementById('createCampaignBtn');
const campaignsContainer = document.getElementById('campaignsContainer');
const loadingIndicator = document.getElementById('loadingIndicator');

// --- åˆå§‹åŒ–å’Œäº‹ä»¶ç›‘å¬ ---

window.addEventListener('load', async () => {
    // æ£€æŸ¥MetaMaskæ˜¯å¦å­˜åœ¨
    if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        
        // ç›‘å¬è´¦æˆ·å˜åŒ–
        window.ethereum.on('accountsChanged', (accounts) => {
            if (accounts.length > 0) {
                handleWalletConnected(accounts[0]);
            } else {
                handleWalletDisconnected();
            }
        });

        // åˆå§‹åŒ–å·¥å‚åˆçº¦å®ä¾‹ï¼Œå³ä½¿æœªè¿æ¥é’±åŒ…ä¹Ÿå¯ä»¥è¯»å–æ•°æ®
        factoryContract = new ethers.Contract(CAMPAIGN_FACTORY_ADDRESS, CAMPAIGN_FACTORY_ABI, provider);
        loadCampaigns();
    } else {
        showToast("è¯·å®‰è£…MetaMaské’±åŒ…!", "error");
        loadingIndicator.textContent = 'è¯·å®‰è£…MetaMaské’±åŒ…ä»¥æµè§ˆé¡¹ç›®ã€‚';
    }

    connectWalletBtn.addEventListener('click', connectWallet);
    createCampaignBtn.addEventListener('click', createCampaign);
});


// ---æ ¸å¿ƒå‡½æ•° ---

/**
 * è¿æ¥ç”¨æˆ·çš„MetaMaské’±åŒ…
 */
async function connectWallet() {
    try {
        const accounts = await provider.send("eth_requestAccounts", []);
        handleWalletConnected(accounts[0]);
    } catch (error) {
        console.error("è¿æ¥é’±åŒ…å¤±è´¥:", error);
        showToast("è¿æ¥é’±åŒ…å¤±è´¥", "error");
    }
}

/**
 * å¤„ç†é’±åŒ…è¿æ¥æˆåŠŸçš„é€»è¾‘
 */
async function handleWalletConnected(account) {
    userAddress = account;
    signer = provider.getSigner();
    
    // æ›´æ–°UI
    connectWalletBtn.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
    showToast("é’±åŒ…è¿æ¥æˆåŠŸï¼");

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯åˆçº¦æ‰€æœ‰è€…ï¼Œä»¥æ˜¾ç¤ºç®¡ç†å‘˜é¢æ¿
    checkAdminStatus();
}

/**
 * å¤„ç†é’±åŒ…æ–­å¼€è¿æ¥çš„é€»è¾‘
 */
function handleWalletDisconnected() {
    userAddress = null;
    signer = null;
    connectWalletBtn.textContent = 'è¿æ¥é’±åŒ…';
    adminPanel.classList.add('hidden');
    showToast("é’±åŒ…å·²æ–­å¼€è¿æ¥", "info");
}


/**
 * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯å·¥å‚åˆçº¦çš„æ‰€æœ‰è€…
 */
async function checkAdminStatus() {
    if(!userAddress) return;
    try {
        const owner = await factoryContract.owner();
        if (userAddress.toLowerCase() === owner.toLowerCase()) {
            adminPanel.classList.remove('hidden');
        } else {
            adminPanel.classList.add('hidden');
        }
    } catch(e) {
        console.error("æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€å¤±è´¥", e);
    }
}

/**
 * ä»å·¥å‚åˆçº¦åŠ è½½æ‰€æœ‰å·²éƒ¨ç½²çš„å‹Ÿæ¬¾é¡¹ç›®
 */
async function loadCampaigns() {
    loadingIndicator.style.display = 'block';
    try {
        const campaignAddresses = await factoryContract.getDeployedCampaigns();
        campaignsContainer.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹

        if(campaignAddresses.length === 0){
             loadingIndicator.textContent = 'æš‚æ— è¿›è¡Œä¸­çš„å¥‘çº¦ï¼Œå¿«è®©é­”æ³•å¸ˆåˆ›å»ºä¸€ä¸ªå§ï¼';
             campaignsContainer.appendChild(loadingIndicator);
             return;
        }

        for (const address of campaignAddresses.reverse()) { //åè½¬æ•°ç»„ï¼Œè®©æœ€æ–°çš„é¡¹ç›®æ˜¾ç¤ºåœ¨æœ€å‰é¢
            const campaignContract = new ethers.Contract(address, CAMPAIGN_ABI, provider);
            const beneficiary = await campaignContract.beneficiary();
            const fundingGoal = await campaignContract.fundingGoal();
            const totalRaised = await campaignContract.totalRaised();
            
            // å‡è®¾USDCæ˜¯6ä½å°æ•°
            const goalInUSDC = ethers.utils.formatUnits(fundingGoal, 6);
            const raisedInUSDC = ethers.utils.formatUnits(totalRaised, 6);
            
            createCampaignCard(address, beneficiary, goalInUSDC, raisedInUSDC);
        }
         loadingIndicator.style.display = 'none';

    } catch (error) {
        console.error("åŠ è½½é¡¹ç›®å¤±è´¥:", error);
        showToast("åŠ è½½é¡¹ç›®å¤±è´¥", "error");
        loadingIndicator.textContent = 'åŠ è½½å¥‘çº¦å¤±è´¥ï¼Œè¯·æ£€æŸ¥åˆçº¦åœ°å€æ˜¯å¦æ­£ç¡®ã€‚';
    }
}


/**
 * åˆ›å»ºæ–°é¡¹ç›® (ç®¡ç†å‘˜åŠŸèƒ½)
 */
async function createCampaign() {
    const beneficiary = document.getElementById('beneficiary').value;
    const fundingGoal = document.getElementById('fundingGoal').value;

    if (!ethers.utils.isAddress(beneficiary)) {
        showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„å—ç›Šäººåœ°å€", "error");
        return;
    }
    if (!fundingGoal || parseFloat(fundingGoal) <= 0) {
        showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„å‹Ÿæ¬¾ç›®æ ‡", "error");
        return;
    }
    
    if (!signer) {
        showToast("è¯·å…ˆè¿æ¥é’±åŒ…", "error");
        return;
    }

    createCampaignBtn.disabled = true;
    createCampaignBtn.textContent = 'å‘èµ·ä¸­...';

    try {
        const factoryWithSigner = factoryContract.connect(signer);
        const goalInWei = ethers.utils.parseUnits(fundingGoal, 6);
        
        const tx = await factoryWithSigner.createCampaign(beneficiary, goalInWei, USDC_TOKEN_ADDRESS);
        showToast("æ­£åœ¨å‘èµ·å¥‘çº¦...è¯·ç­‰å¾…äº¤æ˜“ç¡®è®¤", "info");
        await tx.wait(); 
        
        showToast("å¥‘çº¦å‘èµ·æˆåŠŸ!", "success");
        loadCampaigns(); 
    } catch (error) {
        console.error("å‘èµ·å¥‘çº¦å¤±è´¥:", error);
        showToast("å‘èµ·å¥‘çº¦å¤±è´¥", "error");
    } finally {
        createCampaignBtn.disabled = false;
        createCampaignBtn.textContent = 'å‘èµ·å¥‘çº¦';
    }
}


/**
 * ä¸ºé¡¹ç›®ææ¬¾
 */
async function donate(campaignAddress, amount, buttonElement) {
    if (!signer) {
        showToast("è¯·å…ˆè¿æ¥é’±åŒ…", "error");
        return;
    }

    buttonElement.disabled = true;
    buttonElement.textContent = 'æ³¨å…¥ä¸­...';

    try {
        const usdcContract = new ethers.Contract(USDC_TOKEN_ADDRESS, ERC20_ABI, signer);
        const amountInWei = ethers.utils.parseUnits(amount, 6);

        showToast("æ­£åœ¨è¯·æ±‚æˆæƒ...", "info");
        const approveTx = await usdcContract.approve(campaignAddress, amountInWei);
        await approveTx.wait();
        showToast("æˆæƒæˆåŠŸï¼æ­£åœ¨æ³¨å…¥èƒ½é‡...", "info");

        const campaignContract = new ethers.Contract(campaignAddress, CAMPAIGN_ABI, signer);
        const donateTx = await campaignContract.donate(amountInWei);
        await donateTx.wait();
        
        showToast("èƒ½é‡æ³¨å…¥æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„å®ˆæŠ¤ï¼", "success");
        loadCampaigns(); // åˆ·æ–°é¡¹ç›®æ•°æ®

    } catch (error) {
        console.error("æ³¨å…¥èƒ½é‡å¤±è´¥:", error);
        showToast("æ³¨å…¥èƒ½é‡å¤±è´¥", "error");
    } finally {
        buttonElement.disabled = false;
        buttonElement.textContent = 'æ³¨å…¥èƒ½é‡ï¼âœ¨';
    }
}


// --- UI è¾…åŠ©å‡½æ•° ---

/**
 * åŠ¨æ€åˆ›å»ºé¡¹ç›®å¡ç‰‡å¹¶æ·»åŠ åˆ°é¡µé¢
 */
function createCampaignCard(address, beneficiary, goal, raised) {
    const percentage = parseFloat(goal) > 0 ? (parseFloat(raised) / parseFloat(goal) * 100).toFixed(2) : 0;

    const cardHTML = `
        <div class="card-style p-6 rounded-2xl flex flex-col justify-between transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
            <div>
                <p class="text-xs text-[var(--text-light-color)] break-all mb-2">å¥‘çº¦åœ°å€: ${address}</p>
                <h4 class="text-xl font-bold mb-2 break-words">å®ˆæŠ¤å¯¹è±¡: ${beneficiary.substring(0,8)}...</h4>
                <div class="my-4">
                    <div class="flex justify-between items-center mb-1 text-sm">
                        <span class="main-accent-text font-semibold">${parseFloat(raised).toLocaleString()} USDC</span>
                        <span class="text-[var(--text-light-color)]">ç›®æ ‡: ${parseFloat(goal).toLocaleString()} USDC</span>
                    </div>
                    <div class="w-full bg-[var(--progress-bar-bg)] rounded-full h-2.5">
                        <div class="progress-bar-inner h-2.5 rounded-full" style="width: ${percentage > 100 ? 100 : percentage}%"></div>
                    </div>
                     <p class="text-right text-sm mt-1 text-[var(--text-light-color)]">${percentage}%</p>
                </div>
            </div>
            <div class="mt-4">
                <input type="number" id="donate-amount-${address}" class="w-full bg-[var(--input-bg-color)] p-2 rounded mb-2 border border-[var(--input-border-color)] text-[var(--text-color)]" placeholder="è¾“å…¥èƒ½é‡å€¼ (USDC)">
                <button onclick="handleDonate('${address}')" class="w-full bg-[var(--accent-color)] hover:bg-[var(--accent-hover-color)] text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    æ³¨å…¥èƒ½é‡ï¼âœ¨
                </button>
            </div>
        </div>
    `;
    campaignsContainer.insertAdjacentHTML('beforeend', cardHTML);
}

// ç”±äºonclickä¸èƒ½ç›´æ¥ä¼ é€’å¤æ‚å‚æ•°ï¼Œç”¨ä¸€ä¸ªè¾…åŠ©å‡½æ•°æ¥å¤„ç†
function handleDonate(address) {
    const amountInput = document.getElementById(`donate-amount-${address}`);
    const button = amountInput.nextElementSibling;
    const amount = amountInput.value;
    if (amount && parseFloat(amount) > 0) {
        donate(address, amount, button);
    } else {
        showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„èƒ½é‡å€¼", "error");
    }
}


/**
 * æ˜¾ç¤ºä¸€ä¸ªçŸ­æš‚çš„æ¶ˆæ¯æç¤º
 */
function showToast(message, type = "success") {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');

    toastMessage.textContent = message;
    
    // æ ¹æ®ç±»å‹æ”¹å˜é¢œè‰²
    toast.classList.remove('bg-green-500', 'bg-red-500', 'bg-blue-500', 'bg-slate-700');
    if (type === 'success') {
        toast.classList.add('bg-green-500');
    } else if (type === 'error') {
        toast.classList.add('bg-red-500');
    } else { // info
        toast.classList.add('bg-blue-500');
    }

    toast.classList.remove('hidden');
    setTimeout(() => {
        toast.classList.add('hidden');
    }, 4000); // 4ç§’åè‡ªåŠ¨æ¶ˆå¤±
}

</script>
</body>
</html>
